# 画面遷移図設計書

## 1. 画面一覧

| 画面ID | 画面名 | パス | 認証 | ロール制限 |
|--------|--------|------|------|----------|
| AUTH-01 | ログイン画面 | /login | 不要 | - |
| TASK-01 | タスク一覧画面 | /tasks | 必須 | 全ロール |
| TASK-02 | タスク編集モーダル | /tasks (modal) | 必須 | admin, editor |

---

## 2. 画面遷移フロー

```
┌─────────────────┐
│  アクセス開始    │
└────────┬────────┘
         │
         ↓
    【認証チェック】
         │
    ┌────┴────┐
    │         │
未認証      認証済み
    │         │
    ↓         ↓
┌─────────┐  ┌──────────────┐
│ AUTH-01 │  │   TASK-01    │
│ ログイン │  │ タスク一覧   │
└────┬────┘  └──────┬───────┘
     │              │
  ログイン成功   ┌───┴────┐
     │          │        │
     └──────────┤   ダブルクリック
                │   (admin/editor)
                ↓        │
         ┌──────────┐    │
         │ TASK-02  │←──┘
         │編集モーダル│
         └────┬─────┘
              │
          保存/キャンセル
              │
              ↓
         ┌──────────┐
         │ TASK-01  │
         │一覧に戻る│
         └──────────┘
```

---

## 3. 画面詳細仕様

### 3.1 AUTH-01: ログイン画面

#### 3.1.1 レイアウト

```
┌────────────────────────────────────┐
│                                    │
│        タスク管理システム          │
│                                    │
│  ┌──────────────────────────────┐ │
│  │  Email                        │ │
│  │  [____________________]       │ │
│  │                               │ │
│  │  Password                     │ │
│  │  [____________________]       │ │
│  │                               │ │
│  │  [  ログイン  ]               │ │
│  └──────────────────────────────┘ │
│                                    │
└────────────────────────────────────┘
```

#### 3.1.2 機能要件

| 要素 | 型 | バリデーション | 動作 |
|------|---|---------------|------|
| Email入力 | input[type=email] | 必須、メール形式 | - |
| Password入力 | input[type=password] | 必須、6文字以上 | - |
| ログインボタン | button | - | Server Action実行 |

#### 3.1.3 バリデーション

```typescript
const loginSchema = z.object({
  email: z.string().email('メールアドレスの形式が正しくありません'),
  password: z.string().min(6, 'パスワードは6文字以上である必要があります')
});
```

#### 3.1.4 遷移条件

| 条件 | 遷移先 | 備考 |
|------|--------|------|
| ログイン成功 | /tasks | セッション確立 |
| ログイン失敗 | /login | エラーメッセージ表示 |
| 認証済みアクセス | /tasks | 自動リダイレクト |

---

### 3.2 TASK-01: タスク一覧画面

#### 3.2.1 レイアウト

```
┌──────────────────────────────────────────────────────────────────────┐
│ タスク管理システム                        [ログアウト] [Excel出力]   　　　│
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📊 プロジェクト概要                                                   │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 総タスク数: 15件  完了: 5件  未着手: 7件  進行中: 3件                │  │
│  │ 総工数: 120.5時間  完了率: 33.3%                                  │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  📈 完了率                                                            │
│  ┌──────────────┐                                                    │
│  │              │                                                    │
│  │  [円グラフ]  │                                                     │
│  │              │                                                    │
│  └──────────────┘                                                    │
│                                                                      │
│  📋 タスク一覧                                                        │
│  ┌──────┬──────────┬────┬────────┬────┬──────┬──────────┐            │
│  │コード │タスク名   │状態 │フェーズ │工数 │レベル │ロック     │            │
│  ├──────┼──────────┼────┼────────┼────┼──────┼──────────┤            │
│  │T1-01 │要件定義   │完了 │第1段階  │ 8h │ 中   │          │            │
│  │T1-02 │DB設計    │進行 │第1段階  │16h │ 重   │🔒田中     │            │
│  │T2-01 │UI実装    │未着 │第2段階  │24h │ 重   │           │            │
│  └──────┴──────────┴────┴────────┴────┴──────┴──────────┘            │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 機能要件

| 要素 | 動作 | ロール制限 |
|------|------|-----------|
| タスク一覧 | 全タスク表示 | 全ロール |
| タスク行ダブルクリック | 編集モーダル表示 | admin, editor |
| Excel出力ボタン | Excelダウンロード | 全ロール |
| ロック表示 | 🔒アイコン + ユーザー名 | - |
| 完了率グラフ | Recharts円グラフ | - |
| 統計表示 | リアルタイム自動算出 | - |

#### 3.2.3 表示項目

| カラム | 表示内容 | ソート | フィルター |
|--------|---------|--------|-----------|
| コード | task_code | ○ | × |
| タスク名 | name | ○ | × |
| 状態 | status（日本語） | ○ | ○ |
| フェーズ | phase | ○ | ○ |
| 工数 | effort_hours + "h" | ○ | × |
| レベル | effort_level（軽/中/重） | ○ | ○ |
| ロック | locked_by_user.name | × | × |

#### 3.2.4 状態表示

```typescript
const statusDisplay = {
  NOT_STARTED: { label: '未着手', color: 'gray' },
  IN_PROGRESS: { label: '進行中', color: 'blue' },
  COMPLETED: { label: '完了', color: 'green' }
};

const effortLevelDisplay = {
  LIGHT: { label: '軽', color: 'green' },
  MEDIUM: { label: '中', color: 'yellow' },
  HEAVY: { label: '重', color: 'red' }
};
```

#### 3.2.5 ロック状態表示

| 状態 | 表示 | クリック可否 |
|------|------|-------------|
| 未ロック | - | ○（admin/editor） |
| 自分がロック | 🔒自分 | ○ |
| 他人がロック | 🔒{ユーザー名} | × |
| ロック期限切れ | - | ○（自動解除） |

---

### 3.3 TASK-02: タスク編集モーダル

#### 3.3.1 レイアウト

```
┌────────────────────────────────────────────┐
│  タスク編集                        [×]     │
├────────────────────────────────────────────┤
│                                            │
│  タスクコード: T1-02 (自動生成・変更不可)  │
│                                            │
│  タスク名 *                                │
│  [________________________________]        │
│                                            │
│  状態 *                                    │
│  [ 未着手 ▼ ]                             │
│                                            │
│  フェーズ *                                │
│  [________________________________]        │
│                                            │
│  工数（時間） *                            │
│  [________] h                              │
│                                            │
│  工数レベル *                              │
│  ( ) 軽  ( ) 中  (•) 重                   │
│                                            │
│  詳細説明                                  │
│  [________________________________]        │
│  [________________________________]        │
│  [________________________________]        │
│                                            │
│  [ キャンセル ]           [  保存  ]      │
│                                            │
└────────────────────────────────────────────┘
```

#### 3.3.2 フォーム項目

| 項目 | 型 | 必須 | バリデーション | 備考 |
|------|---|------|---------------|------|
| タスクコード | text | - | - | 表示のみ（編集不可） |
| タスク名 | text | ○ | 1-200文字 | - |
| 状態 | select | ○ | ENUM値 | 未着手/進行中/完了 |
| フェーズ | text | ○ | 1-100文字 | - |
| 工数 | number | ○ | 0.01-9999.99 | 小数点2桁まで |
| 工数レベル | radio | ○ | ENUM値 | 軽/中/重 |
| 詳細説明 | textarea | × | 0-5000文字 | - |

#### 3.3.3 バリデーション

```typescript
const taskSchema = z.object({
  name: z.string()
    .min(1, 'タスク名は必須です')
    .max(200, 'タスク名は200文字以内です'),
  
  status: z.enum(['NOT_STARTED', 'IN_PROGRESS', 'COMPLETED']),
  
  phase: z.string()
    .min(1, 'フェーズは必須です')
    .max(100, 'フェーズは100文字以内です'),
  
  effort_hours: z.number()
    .min(0.01, '工数は0.01以上である必要があります')
    .max(9999.99, '工数は9999.99以下である必要があります'),
  
  effort_level: z.enum(['LIGHT', 'MEDIUM', 'HEAVY']),
  
  description: z.string()
    .max(5000, '詳細説明は5000文字以内です')
    .optional()
});
```

#### 3.3.4 操作フロー

```
【編集開始】
1. タスク行ダブルクリック
2. lockTask() Server Action実行
   ├─ 成功 → モーダル表示
   └─ 失敗 → エラートースト表示（「{ユーザー名}が編集中です」）

【編集中】
3. フォーム入力
   - リアルタイムバリデーション
   - 変更検知

【保存】
4. 保存ボタンクリック
5. クライアントバリデーション
6. updateTask() Server Action実行
   ├─ 成功 → モーダル閉じる → 一覧再描画
   └─ 失敗 → エラー表示

【キャンセル】
7. キャンセル or Esc or モーダル外クリック
8. unlockTask() Server Action実行（ロック解除）
9. モーダル閉じる
```

#### 3.3.5 エラー表示

| エラー種別 | 表示位置 | メッセージ例 |
|-----------|---------|-------------|
| バリデーションエラー | 各入力欄下 | 「タスク名は必須です」 |
| ロック取得失敗 | トースト | 「田中太郎が編集中です」 |
| 保存失敗 | トースト | 「保存に失敗しました」 |
| ネットワークエラー | トースト | 「通信エラーが発生しました」 |

---

## 4. 状態遷移図

### 4.1 認証状態遷移

```
      ┌───────────┐
      │  未認証   │
      └─────┬─────┘
            │
       ログイン
            │
            ↓
      ┌───────────┐
      │  認証済み  │
      └─────┬─────┘
            │
     ログアウト/期限切れ
            │
            ↓
      ┌───────────┐
      │  未認証   │
      └───────────┘
```

### 4.2 タスク状態遷移

```
   ┌──────────┐
   │ 未着手   │
   └─────┬────┘
         │
    ステータス変更
         │
         ↓
   ┌──────────┐     ステータス変更      ┌──────────┐
   │ 進行中   │ ─────────────────────→ │  完了    │
   └─────┬────┘                        └─────┬────┘
         │                                   │
         └───────── 差し戻し ←───────────────┘
                   (逆方向も可)
```

### 4.3 ロック状態遷移

```
   ┌──────────┐
   │ 未ロック │
   └─────┬────┘
         │
    lockTask()
         │
         ↓
   ┌──────────┐
   │ ロック中 │
   └─────┬────┘
         │
    ┌────┴────┐
    │         │
updateTask() 15分経過
    │         │
    ↓         ↓
┌──────────┐ ┌──────────┐
│ 未ロック │ │ 未ロック │
└──────────┘ └──────────┘
  (正常解除)  (自動解除)
```

---

## 5. UI/UXガイドライン

### 5.1 レスポンシブ対応

**対応範囲**: デスクトップのみ（PC想定）

| デバイス | 対応 | 備考 |
|---------|------|------|
| Desktop (1920px~) | ○ | メイン想定 |
| Laptop (1366px~) | ○ | 最小対応幅 |
| Tablet (768px~) | △ | 閲覧のみ |
| Mobile (~767px) | × | 非対応 |

### 5.2 カラーパレット

```typescript
const colors = {
  primary: '#3b82f6',      // Blue-500
  success: '#10b981',      // Green-500
  warning: '#f59e0b',      // Amber-500
  danger: '#ef4444',       // Red-500
  gray: {
    50: '#f9fafb',
    100: '#f3f4f6',
    200: '#e5e7eb',
    500: '#6b7280',
    900: '#111827'
  }
};
```

### 5.3 フォント

```css
font-family: 'Inter', 'Noto Sans JP', sans-serif;

h1: 24px (1.5rem)
h2: 20px (1.25rem)
body: 16px (1rem)
small: 14px (0.875rem)
```

### 5.4 インタラクション

| 要素 | ホバー | アクティブ | フォーカス |
|------|--------|-----------|-----------|
| ボタン | opacity: 0.9 | scale: 0.98 | outline: 2px |
| タスク行 | bg: gray-50 | - | - |
| 入力欄 | - | - | border: blue-500 |

### 5.5 アニメーション

```css
/* モーダル表示 */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* トースト */
@keyframes slideInRight {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

/* ローディング */
@keyframes spin {
  to { transform: rotate(360deg); }
}
```

---

## 6. アクセシビリティ

### 6.1 キーボード操作

| 画面 | キー | 動作 |
|------|------|------|
| モーダル | Esc | モーダル閉じる |
| モーダル | Tab | フォーカス移動 |
| 一覧 | Enter | （行選択時）編集モーダル |

### 6.2 ARIA属性

```html
<!-- モーダル -->
<div role="dialog" aria-labelledby="modal-title" aria-modal="true">
  <h2 id="modal-title">タスク編集</h2>
</div>

<!-- ボタン -->
<button aria-label="Excel出力">
  <DownloadIcon />
</button>

<!-- ロック表示 -->
<span aria-label="田中太郎が編集中">🔒</span>
```

---

## 7. エラー画面

### 7.1 404 Not Found

```
┌────────────────────────────────┐
│                                │
│         404                    │
│    ページが見つかりません      │
│                                │
│  [ トップへ戻る ]              │
│                                │
└────────────────────────────────┘
```

### 7.2 500 Server Error

```
┌────────────────────────────────┐
│                                │
│         500                    │
│   サーバーエラーが発生しました │
│                                │
│  [ 再読み込み ]                │
│                                │
└────────────────────────────────┘
```

### 7.3 403 Forbidden

```
┌────────────────────────────────┐
│                                │
│         403                    │
│      アクセス権限がありません  │
│                                │
│  [ ログイン画面へ ]            │
│                                │
└────────────────────────────────┘
```

---

## 8. 画面遷移マトリクス

| From \ To | AUTH-01 | TASK-01 | TASK-02 |
|-----------|---------|---------|---------|
| AUTH-01 | - | ログイン成功 | - |
| TASK-01 | ログアウト | - | ダブルクリック |
| TASK-02 | - | 保存/キャンセル | - |

---

## 9. URL設計

| パス | 画面 | 認証 | 備考 |
|------|------|------|------|
| / | リダイレクト | - | → /tasks or /login |
| /login | AUTH-01 | 不要 | 認証済みは/tasksへ |
| /tasks | TASK-01 | 必須 | タスク一覧 |
| /tasks?edit={id} | TASK-02 | 必須 | 編集モーダル（URL共有不可） |

---