## 2. 統合テスト（Integration Test）

### 2-1. 認証 Server Actions

#### 2-1-1. login
- [ ] 正しいメール・パスワードでセッションが確立されること
- [ ] 誤ったパスワードで `INVALID_CREDENTIALS` エラーが返ること
- [ ] 存在しないメールアドレスで `INVALID_CREDENTIALS` エラーが返ること
- [ ] ログイン後にセッションにロール情報が含まれること

#### 2-1-2. logout
- [ ] ログアウト後にセッションが破棄されること
- [ ] ログアウト後に `/tasks` にアクセスすると `/login` にリダイレクトされること

---

### 2-2. タスク管理 Server Actions

#### 2-2-1. getTasks
- [ ] 認証済みで対象プロジェクトのタスク一覧が取得できること
- [ ] タスクコード昇順で返却されること
- [ ] ロック中タスクにロックユーザー情報が付与されること
- [ ] 未認証でアクセスすると `UNAUTHORIZED` エラーが返ること
- [ ] 存在しない `projectId` で `NOT_FOUND` エラーが返ること

#### 2-2-2. getTask
- [ ] 指定 `taskId` の単一タスクが取得できること
- [ ] 存在しない `taskId` で `NOT_FOUND` エラーが返ること
- [ ] 未認証でアクセスすると `UNAUTHORIZED` エラーが返ること

#### 2-2-3. createTask
- [ ] 有効なデータでタスクが作成されること
- [ ] `task_code` が自動生成されること（`T1-01` 形式）
- [ ] 同フェーズで2件目作成時に `task_code` がインクリメントされること
- [ ] `status` のデフォルト値が `NOT_STARTED` になること
- [ ] viewer ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 未認証で実行すると `UNAUTHORIZED` エラーが返ること
- [ ] バリデーションエラーデータで `VALIDATION_ERROR` が返ること
- [ ] 存在しない `project_id` で外部キー制約エラーが返ること

#### 2-2-4. updateTask
- [ ] ロック所有者が正しくタスクを更新できること
- [ ] 更新後にロックが自動解除（`locked_by: null`）されること
- [ ] `updated_at` が更新されること
- [ ] ロックを保持していない状態で実行すると `LOCK_NOT_HELD` エラーが返ること
- [ ] viewer ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 存在しない `taskId` で `NOT_FOUND` エラーが返ること
- [ ] バリデーションエラーデータで `VALIDATION_ERROR` が返ること
- [ ] 更新後に `/tasks` のキャッシュが再検証されること

#### 2-2-5. deleteTask
- [ ] admin ロールでタスクが物理削除されること
- [ ] 削除後にタスクが取得できなくなること
- [ ] editor ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] viewer ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 存在しない `taskId` で `NOT_FOUND` エラーが返ること

---

### 2-3. ロック制御 Server Actions

#### 2-3-1. lockTask
- [ ] 未ロック状態のタスクをロック取得できること
- [ ] ロック後に `locked_by` と `locked_at` が設定されること
- [ ] 他ユーザーがロック中（期限内）に取得しようとすると `LOCKED_BY_OTHER` エラーが返ること
- [ ] エラーメッセージにロック中ユーザー名が含まれること
- [ ] ロック期限切れ（15分超過）後に別ユーザーがロックを取得できること
- [ ] viewer ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 存在しない `taskId` で `NOT_FOUND` エラーが返ること
- [ ] 自分が既にロック中のタスクで再度 `lockTask` を実行してもエラーにならないこと

#### 2-3-2. unlockTask
- [ ] admin ロールでロックが強制解除されること
- [ ] 解除後に `locked_by` と `locked_at` が `null` になること
- [ ] editor ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 未ロックのタスクに実行してもエラーにならないこと

---

### 2-4. 統計 Server Actions

#### 2-4-1. getProjectStats
- [ ] タスク総数が正確に返ること
- [ ] 完了・進行中・未着手の件数が正確に返ること
- [ ] 完了率（%）が正確に計算されること（小数点2桁）
- [ ] 総工数が正確に集計されること
- [ ] タスクが0件のとき `completionRate` が 0 になること
- [ ] 未認証でアクセスすると `UNAUTHORIZED` エラーが返ること

---

### 2-5. Excel出力 Server Action

#### 2-5-1. exportTasksToExcel
- [ ] タスク一覧がExcelファイル（Buffer）として出力されること
- [ ] ヘッダー行（ID・タスク名・工数）が含まれること
- [ ] ヘッダー行にボールド・背景色が設定されること
- [ ] タスクコード昇順でデータが並んでいること
- [ ] 未認証でアクセスすると `UNAUTHORIZED` エラーが返ること
- [ ] タスクが0件のとき空のワークシートが出力されること

---

### 2-6. DBバックアップ

#### 2-6-1. dumpDB
- [ ] admin ロールでDBダンプが実行されること
- [ ] 出力ファイルが `.sql` 形式であること
- [ ] editor/viewer ロールで実行すると `FORBIDDEN` エラーが返ること
- [ ] 未認証で実行すると `UNAUTHORIZED` エラーが返ること

---

### 2-7. データ整合性

#### 2-7-1. 外部キー制約
- [ ] プロジェクト削除時に関連タスクが CASCADE 削除されること
- [ ] ユーザー削除時にタスクの `locked_by` が `SET NULL` になること
- [ ] ロールが参照されている状態でロール削除しようとすると `RESTRICT` エラーになること

#### 2-7-2. ユニーク制約
- [ ] 同一プロジェクト内で `task_code` が重複するとエラーになること
- [ ] 同一メールアドレスのユーザー重複登録でエラーになること
