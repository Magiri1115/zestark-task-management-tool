## 3. E2Eテスト（End-to-End Test）

### 3-1. 認証フロー

#### 3-1-1. ログイン画面（AUTH-01）
- [ ] `/login` にアクセスするとログイン画面が表示されること
- [ ] 認証済みユーザーが `/login` にアクセスすると `/tasks` にリダイレクトされること
- [ ] Email・Password 入力後にログインボタンが押せること
- [ ] 正しい認証情報でログインすると `/tasks` に遷移すること
- [ ] 誤った認証情報でエラーメッセージが表示されること
- [ ] Email 未入力でログインボタンを押すとバリデーションエラーが表示されること

#### 3-1-2. ログアウト
- [ ] ログアウトボタンクリックでセッションが破棄されること
- [ ] ログアウト後に `/tasks` にアクセスすると `/login` にリダイレクトされること

#### 3-1-3. 認証ガード
- [ ] 未認証で `/tasks` にアクセスすると `/login` にリダイレクトされること
- [ ] 未認証で `/tasks?edit=xxx` にアクセスすると `/login` にリダイレクトされること

---

### 3-2. タスク一覧画面（TASK-01）

#### 3-2-1. 画面表示
- [ ] ログイン後にタスク一覧が表示されること
- [ ] プロジェクト概要（総タスク数・完了数・未着手数・進行中数・総工数・完了率）が表示されること
- [ ] 完了率が円グラフで表示されること
- [ ] タスク行にコード・タスク名・状態・フェーズ・工数・レベル・ロック情報が表示されること

#### 3-2-2. ロック状態の表示
- [ ] ロックされていないタスクの「編集」ボタンが有効（クリック可能）であること
- [ ] 他ユーザーがロック中のタスクの「編集」ボタンが無効（グレーアウト）であること
- [ ] ロック中タスクに 🔒 アイコンとユーザー名が表示されること

#### 3-2-3. ステータス表示
- [ ] `NOT_STARTED` が「未着手」と表示されること
- [ ] `IN_PROGRESS` が「進行中」と表示されること
- [ ] `COMPLETED` が「完了」と表示されること

#### 3-2-4. 権限別 UI 制御
- [ ] admin/editor ロールでは各タスクに「編集」ボタンが表示されること
- [ ] viewer ロールでは「編集」ボタンが非表示であること
- [ ] admin ロールでは「DBバックアップ」ボタンが表示されること
- [ ] admin 以外のロールでは「DBバックアップ」ボタンが非表示であること

#### 3-2-5. Excel出力
- [ ] 「Excel出力」ボタンクリックで `.xlsx` ファイルがダウンロードされること
- [ ] ダウンロードファイルにタスク一覧データが含まれること

---

### 3-3. タスク編集モーダル（TASK-02）

#### 3-3-1. モーダルの開閉
- [ ] 「編集」ボタンクリックでモーダルが表示されること
- [ ] モーダル表示時に `lockTask()` が実行されロックが取得されること
- [ ] 他ユーザーロック中の「編集」ボタンをクリックするとエラートーストが表示されること
- [ ] × ボタンクリックでモーダルが閉じること
- [ ] Esc キー押下でモーダルが閉じること
- [ ] キャンセルボタンクリックでモーダルが閉じること
- [ ] モーダルを閉じる際に `unlockTask()` が実行されロックが解除されること

#### 3-3-2. フォーム入力（フォーム入力タブ）
- [ ] タスクコードが読み取り専用で表示されること（編集不可）
- [ ] タスク名・状態・フェーズ・工数・工数レベル・詳細説明が編集できること
- [ ] 必須項目（*）が空のまま保存しようとするとバリデーションエラーが表示されること
- [ ] 各項目のバリデーションエラーが入力欄の下に表示されること

#### 3-3-3. JSON一括入力タブ
- [ ] タブ切り替えで JSON 入力エリアが表示されること
- [ ] 「バリデーション」ボタンで JSON 構文チェックが実行されること
- [ ] 正しい JSON を入力して保存するとタスクが更新されること
- [ ] 不正な JSON でバリデーションエラーが表示されること
- [ ] JSON の `effort_level` に日本語（軽/中/重）と英語（LIGHT/MEDIUM/HEAVY）の両方が受け入れられること
- [ ] JSON の `status` に日本語（未着手/進行中/完了）と英語（NOT_STARTED 等）の両方が受け入れられること

#### 3-3-4. 保存操作
- [ ] 正しいデータで「保存」をクリックするとタスクが更新されること
- [ ] 保存後にモーダルが閉じること
- [ ] 保存後にトースト「保存しました」が表示されること
- [ ] 保存後に一覧が再描画されて変更が反映されること
- [ ] 保存成功後にロックが解除されること

#### 3-3-5. 削除操作
- [ ] 「削除」ボタンをクリックすると確認ダイアログが表示されること
- [ ] 確認ダイアログで「OK」を選択するとタスクが削除されること
- [ ] 削除後にモーダルが閉じ、一覧からタスクが消えること
- [ ] 確認ダイアログで「キャンセル」を選択するとタスクが削除されないこと
- [ ] admin 以外のロールでは「削除」ボタンが非表示または無効であること

---

### 3-4. ロック競合シナリオ

#### 3-4-1. 同時編集
- [ ] User1 がモーダルを開いた状態で User2 が同じタスクの編集ボタンをクリックするとエラートーストが表示されること
- [ ] エラートーストに編集中ユーザー名が表示されること
- [ ] User2 のモーダルが開かないこと

#### 3-4-2. ブラウザ強制終了後のロック自動解除
- [ ] ロック取得後15分経過するとロックが自動解除され、別ユーザーが編集できること

---

### 3-5. DBバックアップモーダル（TASK-03）

#### 3-5-1. バックアップ操作
- [ ] admin ロールで「DBバックアップ」ボタンをクリックするとモーダルが表示されること
- [ ] 「今すぐバックアップ」の「ダウンロード」ボタンをクリックすると `.sql` ファイルがダウンロードされること
- [ ] 自動バックアップ履歴（直近3件）が一覧表示されること
- [ ] 各履歴の「ダウンロード」ボタンからファイルがダウンロードできること
- [ ] × ボタンまたは Esc キーでモーダルが閉じること

---

### 3-6. エラーページ

#### 3-6-1. HTTPエラー画面
- [ ] 存在しないURLにアクセスすると 404 画面が表示されること
- [ ] 404 画面に「トップへ戻る」ボタンが表示され、クリックすると `/tasks` に遷移すること
- [ ] サーバーエラー発生時に 500 画面が表示されること
- [ ] 500 画面に「再読み込み」ボタンが表示されること
- [ ] 権限なしアクセス時に 403 画面が表示されること
